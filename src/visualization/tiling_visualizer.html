<!DOCTYPE html>
<meta charset="utf-8">
<style>
.svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
    overflow: hidden;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 0;
    left: 0;
}

body {
  margin: 0;
  overflow: hidden;
}


</style>

<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-tile.v0.0.min.js"></script>
<script>
/*
This script is based on http://bl.ocks.org/mbostock/5914438
*/

var pi = Math.PI,
    tau = 2 * pi;
    
var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight);

var projection = d3.geoMercator()
    .scale(1 / tau)
    .translate([0, 0]);

var tile = d3.tile()
    .size([width, height]);


var zoom = d3.zoom()
    .scaleExtent([1 << 8, 1 << 15])
    .on("zoom", zoomed);

var svg = d3.select('body')
    .append('div').classed('svg-container', true)
      .append('svg')
      .attr("preserveAspectRatio", "xMinYMin meet")
      .attr("viewBox", "0 0 " + width + " " + height)
      .classed("svg-content-responsive", true);

var raster = svg.append("g");

var center = [0, 0];

svg
  .call(zoom)
  .call(zoom.transform, d3.zoomIdentity
      .translate(width / 2, height / 2)
      .scale(1 << 10)
      .translate(-center[0], -center[1]));


function zoomed() {
  var transform = d3.event.transform;

  var tiles = tile
      .scale(transform.k)
      .translate([transform.x, transform.y])
      ();
  console.log(tiles);

  var image = raster
      .attr("transform", stringify(tiles.scale, tiles.translate))
    .selectAll("image")
    .data(tiles, function(d) { return d; });


  image.exit().remove();

  image.enter().append("image")
      .attr("xlink:href", function(d) { 
        var z = d[2],
            k = 1 << z,
            x = d[0],
            y = d[1];
            if(x < k && y < k) {
                return "/tiles/" + x + "_" + y + "_" + z + ".png";
            }
      })
      .attr("x", function(d) { return d[0] * 256; })
      .attr("y", function(d) { return d[1] * 256; })
      .attr("width", 256)
      .attr("height", 256);
}

function stringify(scale, translate) {
  var k = scale / 256, r = scale % 1 ? Number : Math.round;
  return "translate(" + r(translate[0] * scale) + "," + r(translate[1] * scale) + ") scale(" + k + ")";
}

</script>
</body>
